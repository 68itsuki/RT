## 第7章：ルーティングの導入（React Router）

### 7-1. ルーティングとは何か？

#### 7-1-1. ルーティングの基本概念

**ルーティング（Routing）**とは、URLに応じて適切なコンポーネントを表示する機能のことです。

**従来のWebサイト vs SPA（Single Page Application）**

```jsx
// 従来のWebサイト（マルチページアプリケーション）
// ページ遷移時にサーバーから新しいHTMLを取得
<a href="/about">Aboutページへ</a> // ページ全体がリロード

// SPA（React + React Router）
// ページ遷移時にJavaScriptでコンポーネントを切り替え
<Link to="/about">Aboutページへ</Link> // ページリロードなし
```

**React Routerの利点：**
- ページリロードなしの高速な画面遷移
- ブラウザの戻る・進むボタンとの連携
- URLの直接アクセスが可能
- SEOフレンドリーなURL設計

#### 7-1-2. React Routerの種類

React Routerには複数のバージョンがあります：

- **React Router v6**: 最新版（推奨）
- **React Router v5**: 旧版
- **React Router v4**: レガシー版

この章では最新のReact Router v6について説明します。

### 7-2. React Routerのインストールとセットアップ

#### 7-2-1. インストール

```bash
# npmを使用する場合
npm install react-router-dom

# yarnを使用する場合
yarn add react-router-dom

# pnpmを使用する場合
pnpm add react-router-dom
```

#### 7-2-2. 基本的なセットアップ

```jsx
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import Home from './pages/Home';
import About from './pages/About';
import Contact from './pages/Contact';

function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="/about" element={<About />} />
        <Route path="/contact" element={<Contact />} />
      </Routes>
    </BrowserRouter>
  );
}

export default App;
```

**各コンポーネントの役割：**

- **`BrowserRouter`**: ブラウザの履歴APIを使用するルーター
- **`Routes`**: ルート定義をグループ化するコンテナ
- **`Route`**: 個別のルート定義（パスとコンポーネントの対応）

#### 7-2-3. ページコンポーネントの作成

```jsx
// pages/Home.jsx
function Home() {
  return (
    <div>
      <h1>ホームページ</h1>
      <p>ようこそ！</p>
    </div>
  );
}

export default Home;

// pages/About.jsx
function About() {
  return (
    <div>
      <h1>Aboutページ</h1>
      <p>私たちについて</p>
    </div>
  );
}

export default About;

// pages/Contact.jsx
function Contact() {
  return (
    <div>
      <h1>お問い合わせ</h1>
      <p>連絡先情報</p>
    </div>
  );
}

export default Contact;
```

### 7-3. ナビゲーション

#### 7-3-1. `Link`コンポーネント

HTMLの`<a>`タグの代わりに`<Link>`を使用することで、ページリロードなしの遷移が可能になります。

```jsx
import { Link } from 'react-router-dom';

function Navigation() {
  return (
    <nav>
      <ul>
        <li><Link to="/">ホーム</Link></li>
        <li><Link to="/about">About</Link></li>
        <li><Link to="/contact">お問い合わせ</Link></li>
      </ul>
    </nav>
  );
}
```

#### 7-3-2. `NavLink`コンポーネント

現在のページに応じてスタイルを変更したい場合は`<NavLink>`を使用します。

```jsx
import { NavLink } from 'react-router-dom';

function Navigation() {
  return (
    <nav>
      <ul>
        <li>
          <NavLink 
            to="/" 
            className={({ isActive }) => isActive ? 'active' : ''}
          >
            ホーム
          </NavLink>
        </li>
        <li>
          <NavLink 
            to="/about"
            className={({ isActive }) => isActive ? 'active' : ''}
          >
            About
          </NavLink>
        </li>
        <li>
          <NavLink 
            to="/contact"
            className={({ isActive }) => isActive ? 'active' : ''}
          >
            お問い合わせ
          </NavLink>
        </li>
      </ul>
    </nav>
  );
}
```

**CSS例：**
```css
.active {
  color: #007bff;
  font-weight: bold;
  text-decoration: underline;
}
```

#### 7-3-3. プログラムによるナビゲーション

JavaScriptでページ遷移を行いたい場合は`useNavigate`フックを使用します。

```jsx
import { useNavigate } from 'react-router-dom';

function LoginForm() {
  const navigate = useNavigate();
  const [formData, setFormData] = useState({
    email: '',
    password: ''
  });

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    try {
      // ログイン処理
      const response = await loginUser(formData);
      
      if (response.success) {
        // ログイン成功時にダッシュボードへ遷移
        navigate('/dashboard');
      }
    } catch (error) {
      console.error('ログインエラー:', error);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <input
        type="email"
        value={formData.email}
        onChange={(e) => setFormData({...formData, email: e.target.value})}
        placeholder="メールアドレス"
      />
      <input
        type="password"
        value={formData.password}
        onChange={(e) => setFormData({...formData, password: e.target.value})}
        placeholder="パスワード"
      />
      <button type="submit">ログイン</button>
    </form>
  );
}
```

**`useNavigate`の主なメソッド：**
```jsx
const navigate = useNavigate();

// 指定したパスに遷移
navigate('/dashboard');

// 履歴を置き換える（戻るボタンで前のページに戻れない）
navigate('/dashboard', { replace: true });

// 相対パスでの遷移
navigate('../users');

// 履歴を操作
navigate(-1); // 1ページ戻る
navigate(1);  // 1ページ進む
```

### 7-4. 動的ルーティング

#### 7-4-1. URLパラメータ

動的な値（ユーザーID、商品IDなど）をURLに含めることができます。

```jsx
// App.jsx
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import UserList from './pages/UserList';
import UserDetail from './pages/UserDetail';

function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/users" element={<UserList />} />
        <Route path="/users/:id" element={<UserDetail />} />
      </Routes>
    </BrowserRouter>
  );
}
```

**パラメータの取得：**
```jsx
import { useParams } from 'react-router-dom';

function UserDetail() {
  const { id } = useParams();
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchUser = async () => {
      try {
        const response = await fetch(`/api/users/${id}`);
        const userData = await response.json();
        setUser(userData);
      } catch (error) {
        console.error('ユーザー取得エラー:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchUser();
  }, [id]);

  if (loading) return <div>読み込み中...</div>;
  if (!user) return <div>ユーザーが見つかりません</div>;

  return (
    <div>
      <h1>ユーザー詳細</h1>
      <h2>{user.name}</h2>
      <p>Email: {user.email}</p>
      <p>役職: {user.role}</p>
    </div>
  );
}
```

#### 7-4-2. 複数のパラメータ

複数のパラメータを定義することも可能です。

```jsx
// App.jsx
<Route path="/products/:category/:id" element={<ProductDetail />} />

// ProductDetail.jsx
function ProductDetail() {
  const { category, id } = useParams();
  
  return (
    <div>
      <h1>商品詳細</h1>
      <p>カテゴリ: {category}</p>
      <p>商品ID: {id}</p>
    </div>
  );
}
```

#### 7-4-3. オプショナルパラメータ

パラメータをオプショナルにすることもできます。

```jsx
// App.jsx
<Route path="/blog/:year?/:month?/:day?" element={<Blog />} />

// Blog.jsx
function Blog() {
  const { year, month, day } = useParams();
  
  if (year && month && day) {
    return <div>特定の日付のブログ: {year}/{month}/{day}</div>;
  } else if (year && month) {
    return <div>特定の月のブログ: {year}/{month}</div>;
  } else if (year) {
    return <div>特定の年のブログ: {year}</div>;
  } else {
    return <div>すべてのブログ記事</div>;
  }
}
```

### 7-5. ネストしたルーティング

#### 7-5-1. 基本的なネスト

親ルートの中に子ルートを定義することができます。

```jsx
// App.jsx
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import Dashboard from './pages/Dashboard';
import UserList from './pages/UserList';
import UserDetail from './pages/UserDetail';
import Settings from './pages/Settings';

function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/dashboard" element={<Dashboard />}>
          <Route path="users" element={<UserList />} />
          <Route path="users/:id" element={<UserDetail />} />
          <Route path="settings" element={<Settings />} />
        </Route>
      </Routes>
    </BrowserRouter>
  );
}
```

**親コンポーネント（Dashboard.jsx）：**
```jsx
import { Outlet } from 'react-router-dom';

function Dashboard() {
  return (
    <div>
      <header>
        <h1>ダッシュボード</h1>
        <nav>
          <Link to="/dashboard/users">ユーザー一覧</Link>
          <Link to="/dashboard/settings">設定</Link>
        </nav>
      </header>
      
      <main>
        <Outlet /> {/* 子ルートのコンポーネントがここに表示される */}
      </main>
    </div>
  );
}
```

#### 7-5-2. インデックスルート

親ルートにアクセスした時に表示されるデフォルトのコンポーネントを定義できます。

```jsx
// App.jsx
<Route path="/dashboard" element={<Dashboard />}>
  <Route index element={<DashboardHome />} /> {/* デフォルトページ */}
  <Route path="users" element={<UserList />} />
  <Route path="settings" element={<Settings />} />
</Route>

// DashboardHome.jsx
function DashboardHome() {
  return (
    <div>
      <h2>ダッシュボードホーム</h2>
      <p>ようこそ！</p>
    </div>
  );
}
```

### 7-6. ルートガード（認証・認可）

#### 7-6-1. 基本的なルートガード

認証が必要なページへのアクセスを制御します。

```jsx
// components/ProtectedRoute.jsx
import { Navigate } from 'react-router-dom';

function ProtectedRoute({ children }) {
  const isAuthenticated = localStorage.getItem('token'); // 実際の認証ロジック

  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }

  return children;
}

// App.jsx
<Route 
  path="/dashboard" 
  element={
    <ProtectedRoute>
      <Dashboard />
    </ProtectedRoute>
  }
>
  <Route path="users" element={<UserList />} />
  <Route path="settings" element={<Settings />} />
</Route>
```

#### 7-6-2. ロールベースのアクセス制御

ユーザーの役職に応じてアクセスを制御します。

```jsx
// components/RoleBasedRoute.jsx
import { Navigate } from 'react-router-dom';

function RoleBasedRoute({ children, requiredRole }) {
  const userRole = localStorage.getItem('userRole'); // 実際のユーザー情報取得

  if (userRole !== requiredRole) {
    return <Navigate to="/unauthorized" replace />;
  }

  return children;
}

// App.jsx
<Route 
  path="/admin" 
  element={
    <RoleBasedRoute requiredRole="admin">
      <AdminPanel />
    </RoleBasedRoute>
  }
/>
```

#### 7-6-3. 認証状態の管理

より高度な認証状態管理の例：

```jsx
// hooks/useAuth.js
import { useState, useEffect, createContext, useContext } from 'react';

const AuthContext = createContext();

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // 初期認証状態の確認
    checkAuthStatus();
  }, []);

  const checkAuthStatus = async () => {
    try {
      const token = localStorage.getItem('token');
      if (token) {
        const response = await fetch('/api/auth/me', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (response.ok) {
          const userData = await response.json();
          setUser(userData);
        } else {
          localStorage.removeItem('token');
        }
      }
    } catch (error) {
      console.error('認証確認エラー:', error);
    } finally {
      setLoading(false);
    }
  };

  const login = async (credentials) => {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(credentials)
    });

    if (response.ok) {
      const { token, user: userData } = await response.json();
      localStorage.setItem('token', token);
      setUser(userData);
      return { success: true };
    } else {
      return { success: false, error: 'ログインに失敗しました' };
    }
  };

  const logout = () => {
    localStorage.removeItem('token');
    setUser(null);
  };

  return (
    <AuthContext.Provider value={{ user, loading, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  return useContext(AuthContext);
}

// components/ProtectedRoute.jsx
import { Navigate, useLocation } from 'react-router-dom';
import { useAuth } from '../hooks/useAuth';

function ProtectedRoute({ children }) {
  const { user, loading } = useAuth();
  const location = useLocation();

  if (loading) {
    return <div>読み込み中...</div>;
  }

  if (!user) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }

  return children;
}
```

### 7-7. クエリパラメータ

#### 7-7-1. 基本的なクエリパラメータ

URLのクエリ部分（`?key=value`）を扱います。

```jsx
import { useSearchParams } from 'react-router-dom';

function ProductList() {
  const [searchParams, setSearchParams] = useSearchParams();
  const [products, setProducts] = useState([]);

  const category = searchParams.get('category');
  const sort = searchParams.get('sort') || 'name';

  useEffect(() => {
    const fetchProducts = async () => {
      let url = '/api/products';
      const params = new URLSearchParams();
      
      if (category) params.append('category', category);
      if (sort) params.append('sort', sort);
      
      if (params.toString()) {
        url += `?${params.toString()}`;
      }

      const response = await fetch(url);
      const data = await response.json();
      setProducts(data);
    };

    fetchProducts();
  }, [category, sort]);

  const handleCategoryChange = (newCategory) => {
    setSearchParams(prev => {
      const newParams = new URLSearchParams(prev);
      if (newCategory) {
        newParams.set('category', newCategory);
      } else {
        newParams.delete('category');
      }
      return newParams;
    });
  };

  return (
    <div>
      <h1>商品一覧</h1>
      
      <div>
        <button onClick={() => handleCategoryChange('')}>すべて</button>
        <button onClick={() => handleCategoryChange('electronics')}>電子機器</button>
        <button onClick={() => handleCategoryChange('clothing')}>衣類</button>
      </div>

      <ul>
        {products.map(product => (
          <li key={product.id}>{product.name}</li>
        ))}
      </ul>
    </div>
  );
}
```

#### 7-7-2. 複数のクエリパラメータ

```jsx
function AdvancedSearch() {
  const [searchParams, setSearchParams] = useSearchParams();
  
  const query = searchParams.get('q') || '';
  const category = searchParams.get('category') || '';
  const priceMin = searchParams.get('priceMin') || '';
  const priceMax = searchParams.get('priceMax') || '';

  const updateSearch = (updates) => {
    setSearchParams(prev => {
      const newParams = new URLSearchParams(prev);
      Object.entries(updates).forEach(([key, value]) => {
        if (value) {
          newParams.set(key, value);
        } else {
          newParams.delete(key);
        }
      });
      return newParams;
    });
  };

  return (
    <div>
      <input
        type="text"
        placeholder="検索..."
        value={query}
        onChange={(e) => updateSearch({ q: e.target.value })}
      />
      
      <select
        value={category}
        onChange={(e) => updateSearch({ category: e.target.value })}
      >
        <option value="">すべてのカテゴリ</option>
        <option value="electronics">電子機器</option>
        <option value="clothing">衣類</option>
        <option value="books">書籍</option>
      </select>

      <input
        type="number"
        placeholder="最低価格"
        value={priceMin}
        onChange={(e) => updateSearch({ priceMin: e.target.value })}
      />

      <input
        type="number"
        placeholder="最高価格"
        value={priceMax}
        onChange={(e) => updateSearch({ priceMax: e.target.value })}
      />
    </div>
  );
}
```

### 7-8. エラーハンドリング

#### 7-8-1. 404エラーページ

存在しないルートにアクセスした時の処理。

```jsx
// App.jsx
<Routes>
  <Route path="/" element={<Home />} />
  <Route path="/about" element={<About />} />
  <Route path="*" element={<NotFound />} /> {/* ワイルドカードルート */}
</Routes>

// pages/NotFound.jsx
import { Link } from 'react-router-dom';

function NotFound() {
  return (
    <div>
      <h1>404 - ページが見つかりません</h1>
      <p>お探しのページは存在しないか、移動された可能性があります。</p>
      <Link to="/">ホームに戻る</Link>
    </div>
  );
}
```

#### 7-8-2. エラーバウンダリとの組み合わせ

```jsx
// components/ErrorBoundary.jsx
import { Component } from 'react';

class ErrorBoundary extends Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    console.error('エラーが発生しました:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return (
        <div>
          <h1>エラーが発生しました</h1>
          <button onClick={() => window.location.reload()}>
            ページを再読み込み
          </button>
        </div>
      );
    }

    return this.props.children;
  }
}

// App.jsx
function App() {
  return (
    <ErrorBoundary>
      <BrowserRouter>
        <Routes>
          {/* ルート定義 */}
        </Routes>
      </BrowserRouter>
    </ErrorBoundary>
  );
}
```

### 7-9. 実践的な応用例

#### 7-9-1. 完全なアプリケーション例

```jsx
// App.jsx
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { AuthProvider } from './hooks/useAuth';
import Navigation from './components/Navigation';
import Home from './pages/Home';
import Login from './pages/Login';
import Dashboard from './pages/Dashboard';
import UserList from './pages/UserList';
import UserDetail from './pages/UserDetail';
import Settings from './pages/Settings';
import NotFound from './pages/NotFound';
import ProtectedRoute from './components/ProtectedRoute';

function App() {
  return (
    <AuthProvider>
      <BrowserRouter>
        <Navigation />
        <Routes>
          <Route path="/" element={<Home />} />
          <Route path="/login" element={<Login />} />
          
          <Route 
            path="/dashboard" 
            element={
              <ProtectedRoute>
                <Dashboard />
              </ProtectedRoute>
            }
          >
            <Route index element={<DashboardHome />} />
            <Route path="users" element={<UserList />} />
            <Route path="users/:id" element={<UserDetail />} />
            <Route path="settings" element={<Settings />} />
          </Route>
          
          <Route path="*" element={<NotFound />} />
        </Routes>
      </BrowserRouter>
    </AuthProvider>
  );
}

// components/Navigation.jsx
import { NavLink } from 'react-router-dom';
import { useAuth } from '../hooks/useAuth';

function Navigation() {
  const { user, logout } = useAuth();

  return (
    <nav>
      <NavLink to="/">ホーム</NavLink>
      
      {user ? (
        <>
          <NavLink to="/dashboard">ダッシュボード</NavLink>
          <button onClick={logout}>ログアウト</button>
        </>
      ) : (
        <NavLink to="/login">ログイン</NavLink>
      )}
    </nav>
  );
}
```

#### 7-9-2. レイアウトコンポーネント

```jsx
// components/Layout.jsx
import { Outlet } from 'react-router-dom';
import Header from './Header';
import Footer from './Footer';

function Layout() {
  return (
    <div>
      <Header />
      <main>
        <Outlet />
      </main>
      <Footer />
    </div>
  );
}

// App.jsx
<Routes>
  <Route path="/" element={<Layout />}>
    <Route index element={<Home />} />
    <Route path="about" element={<About />} />
    <Route path="contact" element={<Contact />} />
  </Route>
</Routes>
```

### 7-10. パフォーマンス最適化

#### 7-10-1. コード分割（Code Splitting）

```jsx
import { lazy, Suspense } from 'react';

// 遅延読み込み
const Dashboard = lazy(() => import('./pages/Dashboard'));
const UserList = lazy(() => import('./pages/UserList'));

function App() {
  return (
    <BrowserRouter>
      <Suspense fallback={<div>読み込み中...</div>}>
        <Routes>
          <Route path="/dashboard" element={<Dashboard />} />
          <Route path="/users" element={<UserList />} />
        </Routes>
      </Suspense>
    </BrowserRouter>
  );
}
```

#### 7-10-2. プリロード

```jsx
import { Link, useLocation } from 'react-router-dom';

function Navigation() {
  const location = useLocation();

  const preloadComponent = (componentPath) => {
    // コンポーネントをプリロード
    import(componentPath);
  };

  return (
    <nav>
      <Link 
        to="/dashboard"
        onMouseEnter={() => preloadComponent('./pages/Dashboard')}
      >
        ダッシュボード
      </Link>
    </nav>
  );
}
```

### 7-11. まとめ

この章では、React Routerを使用したルーティングについて詳しく学びました：

**重要なポイント：**
1. **ルーティングの基本**: URLに応じたコンポーネントの表示
2. **ナビゲーション**: Link、NavLink、useNavigateの使い分け
3. **動的ルーティング**: URLパラメータとクエリパラメータ
4. **ネストしたルーティング**: 親子関係のあるルート構造
5. **ルートガード**: 認証・認可によるアクセス制御
6. **エラーハンドリング**: 404エラーなどの適切な処理

**ベストプラクティス：**
- 適切なルート構造を設計する
- 認証が必要なルートは保護する
- エラーページを用意する
- パフォーマンスを考慮したコード分割を行う
- ユーザビリティを重視したナビゲーションを設計する

これらの知識を活用して、ユーザーフレンドリーで保守性の高いReactアプリケーションを構築しましょう。
